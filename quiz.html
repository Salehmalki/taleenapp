<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <title>اختبار نسب النبي محمد ﷺ</title>
  <link rel="stylesheet" href="assets/css/quiz-golden.css">
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <script src="assets/js/simplified-audio.js" defer></script>
  <script src="assets/js/updated-quiz-questions.js" defer></script>
  
  <style>
    /* نمط جديد للإجابات باستخدام divs بدلاً من الأزرار */
    .answer-choice {
      padding: 15px;
      margin: 10px 0;
      border-radius: 15px;
      background-color: #ffffff;
      border: 1px solid #d1c5a8;
      text-align: center;
      cursor: pointer;
      font-family: 'Amiri', serif;
      font-size: 16px;
      color: #5D4037;
      position: relative;
      transition: background-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    
    /* إضافة تزيين زخرفي */
    .answer-choice::before {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #D4AF37;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    /* تأثير التحويم فقط على الأجهزة غير اللمسية */
    @media (hover: hover) {
      .answer-choice:hover {
        background-color: rgba(212, 175, 55, 0.1);
      }
    }
    
    /* تأثير الضغط - يظهر فقط أثناء الضغط الفعلي */
    .answer-choice.pressed {
      background-color: rgba(212, 175, 55, 0.2);
    }
    
    /* منع التحديد */
    .no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* التخلص من أي تأثيرات تلقائية */
    * {
      -webkit-tap-highlight-color: transparent !important;
      outline: none !important;
    }
  </style>
</head>
<body class="no-select">
  <header>
    <h1>اختبار نسب النبي محمد ﷺ</h1>
    <p class="subtitle">اختبري معلوماتك عن نسب النبي محمد ﷺ</p>
  </header>

  <main>
    <div class="quiz-container">
      <div class="timer-container">
        <div class="timer-progress">
          <div id="timer-bar"></div>
        </div>
        <div id="timer-text">30</div>
      </div>
      
      <div id="question-container">
        <h2 id="question-text">جاري تحميل الأسئلة...</h2>
        <div class="answers-box" id="answers-box">
          <!-- سيتم إنشاء الإجابات ديناميكيًا باستخدام JavaScript -->
        </div>
      </div>
      
      <div id="result-container" style="display: none;">
        <h2>نتيجة الاختبار</h2>
        <p id="result-text"></p>
        <div class="result-buttons">
          <button id="retry-button" class="result-button retry clickable">إعادة الاختبار</button>
          <a href="index.html" class="result-button home clickable">العودة للصفحة الرئيسية</a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>عمل الطالبة: تالين المالكي | إشراف: المعلمة منيرة الدوسري</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // متغيرات الاختبار
      let currentQuestion = 0;
      let score = 0;
      let timer;
      let timeLeft = 30;
      let questions = [];
      
      // تهيئة الاختبار
      function initQuiz() {
        // استخدام الأسئلة المحدثة
        questions = quizQuestions.slice();
        
        // ترتيب الأسئلة عشوائيًا
        shuffleArray(questions);
        
        // عرض السؤال الأول
        showQuestion();
        
        // بدء العداد التنازلي
        startTimer();

        // منع تحديد النص للمستخدمين
        disableTextSelection();
      }

      // منع تحديد النص
      function disableTextSelection() {
        document.body.classList.add('no-select');
      }
      
      // دالة عرض السؤال - مُعدّلة بالكامل
      function showQuestion() {
        const questionData = questions[currentQuestion];
        const questionText = document.getElementById('question-text');
        const answersBox = document.getElementById('answers-box');
        
        // عرض نص السؤال
        questionText.textContent = questionData.q;
        
        // إفراغ حاوية الإجابات
        answersBox.innerHTML = '';
        
        // نسخ مصفوفة الإجابات وترتيبها عشوائيًا
        const answers = [...questionData.a];
        shuffleArray(answers);
        
        // إنشاء عناصر DIV للإجابات بدلاً من الأزرار
        answers.forEach(function(answer) {
          const answerDiv = document.createElement('div');
          answerDiv.className = 'answer-choice';
          answerDiv.textContent = answer;
          
          // إضافة مستمعات الأحداث المخصصة للأجهزة اللمسية والماوس
          setupAnswerEventListeners(answerDiv, answer, questionData);
          
          // إضافة عنصر الإجابة إلى الحاوية
          answersBox.appendChild(answerDiv);
        });
        
        // إعادة ضبط العداد التنازلي
        resetTimer();
      }
      
      // دالة إعداد مستمعات الأحداث للإجابات
      function setupAnswerEventListeners(element, answer, questionData) {
        // مستمع لبدء اللمس - إضافة تأثير الضغط
        element.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.classList.add('pressed');
        }, { passive: false });
        
        // مستمع لانتهاء اللمس - إزالة تأثير الضغط وتنفيذ الإجراء
        element.addEventListener('touchend', function(e) {
          e.preventDefault();
          this.classList.remove('pressed');
          
          // إضافة تأخير صغير قبل التحقق من الإجابة
          setTimeout(() => {
            checkAnswer(answer, questionData);
          }, 10);
        }, { passive: false });
        
        // للماوس: مستمع للضغط
        element.addEventListener('mousedown', function(e) {
          this.classList.add('pressed');
        });
        
        // للماوس: مستمع للإفلات
        element.addEventListener('mouseup', function(e) {
          this.classList.remove('pressed');
          checkAnswer(answer, questionData);
        });
        
        // تجنب بقاء تأثير الضغط إذا تحرك المؤشر خارج العنصر
        element.addEventListener('mouseleave', function() {
          this.classList.remove('pressed');
        });
      }
      
      // دالة التحقق من الإجابة
      function checkAnswer(selectedAnswer, questionData) {
        // إزالة أي تأثيرات متبقية من العناصر
        document.querySelectorAll('.answer-choice').forEach(choice => {
          choice.classList.remove('pressed');
        });
        
        const correctAnswer = questionData.a[questionData.correct];
        
        if (selectedAnswer === correctAnswer) {
          // الإجابة صحيحة
          score++;
          
          // تشغيل صوت النقرة
          if (typeof playClickSound === 'function') {
            playClickSound();
          }
        } else {
          // الإجابة خاطئة
          // تشغيل صوت النقرة
          if (typeof playClickSound === 'function') {
            playClickSound();
          }
        }
        
        // الانتقال إلى السؤال التالي أو إنهاء الاختبار
        currentQuestion++;
        
        // زمن تأخير صغير قبل الانتقال للسؤال التالي (لتحسين تجربة المستخدم)
        setTimeout(() => {
          if (currentQuestion < questions.length) {
            showQuestion();
          } else {
            endQuiz();
          }
        }, 100);
      }
      
      // دالة إنهاء الاختبار
      function endQuiz() {
        // إيقاف العداد التنازلي
        clearInterval(timer);
        
        // إخفاء حاوية المؤقت
        document.querySelector('.timer-container').style.display = 'none';
        
        // إخفاء حاوية الأسئلة وإظهار حاوية النتيجة
        document.getElementById('question-container').style.display = 'none';
        document.getElementById('result-container').style.display = 'block';
        
        // عرض النتيجة
        const resultText = document.getElementById('result-text');
        const percentage = Math.round((score / questions.length) * 100);
        
        resultText.textContent = `لقد حصلت على ${score} من ${questions.length} (${percentage}%)`;
        
        // إذا كانت النتيجة كاملة، عرض رابط الشهادة
        if (score === questions.length) {
          const resultButtons = document.querySelector('.result-buttons');
          
          // إنشاء زر الشهادة إذا لم يكن موجودًا
          if (!document.getElementById('certificate-button')) {
            const certificateButton = document.createElement('a');
            certificateButton.id = 'certificate-button';
            certificateButton.href = 'certificate.html';
            certificateButton.className = 'result-button certificate clickable';
            certificateButton.textContent = 'عرض الشهادة';
            resultButtons.appendChild(certificateButton);
          }
        }
        
        // إضافة مستمع لزر إعادة الاختبار
        document.getElementById('retry-button').addEventListener('click', function() {
          // إعادة تهيئة الاختبار
          currentQuestion = 0;
          score = 0;
          
          // إظهار حاوية المؤقت مرة أخرى
          document.querySelector('.timer-container').style.display = 'flex';
          
          // إخفاء حاوية النتيجة وإظهار حاوية الأسئلة
          document.getElementById('result-container').style.display = 'none';
          document.getElementById('question-container').style.display = 'block';
          
          // إعادة تشغيل الاختبار
          initQuiz();
        });
      }
      
      // دالة بدء العداد التنازلي
      function startTimer() {
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        const timerContainer = document.querySelector('.timer-container');
        
        // إعادة ضبط العداد التنازلي
        timeLeft = 30;
        timerText.textContent = timeLeft;
        timerBar.style.width = '100%';
        timerContainer.classList.remove('timer-warning', 'timer-danger');
        
        // بدء العداد التنازلي
        timer = setInterval(function() {
          timeLeft--;
          timerText.textContent = timeLeft;
          timerBar.style.width = (timeLeft / 30 * 100) + '%';
          
          // تغيير لون العداد عندما يقترب الوقت من النهاية
          if (timeLeft <= 10 && timeLeft > 5) {
            timerContainer.classList.add('timer-warning');
            timerContainer.classList.remove('timer-danger');
          } else if (timeLeft <= 5) {
            timerContainer.classList.remove('timer-warning');
            timerContainer.classList.add('timer-danger');
          }
          
          // إذا انتهى الوقت، الانتقال إلى السؤال التالي
          if (timeLeft <= 0) {
            clearInterval(timer);
            
            // الانتقال إلى السؤال التالي أو إنهاء الاختبار
            currentQuestion++;
            
            if (currentQuestion < questions.length) {
              showQuestion();
            } else {
              endQuiz();
            }
          }
        }, 1000);
      }
      
      // دالة إعادة ضبط العداد التنازلي
      function resetTimer() {
        clearInterval(timer);
        startTimer();
      }
      
      // دالة ترتيب المصفوفة عشوائيًا
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      
      // بدء الاختبار
      initQuiz();

      // معالجة خاصة لمنع التظليل على iOS
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        document.addEventListener('touchend', function(e) {
          // منع أي تظليل أو تأثيرات تركيز بعد اللمس
          setTimeout(function() {
            // تغطية شاملة لكل الأساليب الممكنة لإزالة التظليل
            if (document.activeElement) document.activeElement.blur();
            
            // إلغاء أي تحديد نصي
            if (window.getSelection) {
              if (window.getSelection().empty) {  // Chrome
                window.getSelection().empty();
              } else if (window.getSelection().removeAllRanges) {  // Firefox
                window.getSelection().removeAllRanges();
              }
            }
          }, 10);
        }, false);
      }
    });
  </script>
</body>
</html>
