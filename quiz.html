<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <title>اختبار نسب النبي محمد ﷺ</title>
  <link rel="stylesheet" href="assets/css/quiz-golden.css">
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <script src="assets/js/simplified-audio.js" defer></script>
  <script src="assets/js/updated-quiz-questions.js" defer></script>
</head>
<body class="no-select">
  <header>
    <h1>اختبار نسب النبي محمد ﷺ</h1>
    <p class="subtitle">اختبري معلوماتك عن نسب النبي محمد ﷺ</p>
  </header>

  <main>
    <div class="quiz-container">
      <div class="timer-container">
        <div class="timer-progress">
          <div id="timer-bar"></div>
        </div>
        <div id="timer-text">30</div>
      </div>
      
      <div id="question-container">
        <h2 id="question-text">جاري تحميل الأسئلة...</h2>
        <div class="answers-box" id="answers-box">
          <!-- سيتم إنشاء الإجابات ديناميكيًا باستخدام JavaScript -->
        </div>
      </div>
      
      <div id="result-container" style="display: none;">
        <h2>نتيجة الاختبار</h2>
        <p id="result-text"></p>
        <div class="result-buttons">
          <button id="retry-button" class="result-button retry clickable">إعادة الاختبار</button>
          <a href="index.html" class="result-button home clickable">العودة للصفحة الرئيسية</a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>عمل الطالبة: تالين المالكي | إشراف: المعلمة منيرة الدوسري</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // متغيرات الاختبار
      let currentQuestion = 0;
      let score = 0;
      let timer;
      let timeLeft = 30;
      let questions = [];
      
      // تهيئة الاختبار
      function initQuiz() {
        // استخدام الأسئلة المحدثة
        questions = quizQuestions.slice();
        
        // ترتيب الأسئلة عشوائيًا
        shuffleArray(questions);
        
        // عرض السؤال الأول
        showQuestion();
        
        // بدء العداد التنازلي
        startTimer();

        // منع تحديد النص للمستخدمين
        disableTextSelection();
      }

      // منع تحديد النص
      function disableTextSelection() {
        document.body.classList.add('no-select');
      }
      
      // دالة عرض السؤال
      function showQuestion() {
        const questionData = questions[currentQuestion];
        const questionText = document.getElementById('question-text');
        const answersBox = document.getElementById('answers-box');
        
        // عرض نص السؤال
        questionText.textContent = questionData.q;
        
        // إفراغ حاوية الإجابات
        answersBox.innerHTML = '';
        
        // نسخ مصفوفة الإجابات وترتيبها عشوائيًا
        const answers = questionData.a.slice();
        shuffleArray(answers);
        
        // إنشاء أزرار الإجابات
        answers.forEach(function(answer, index) {
          const button = document.createElement('button');
          button.className = 'clickable';
          button.textContent = answer;
          button.addEventListener('click', function() {
            // التحقق من الإجابة
            checkAnswer(answer, questionData);
          });
          answersBox.appendChild(button);
        });
        
        // إعادة ضبط العداد التنازلي
        resetTimer();
      }
      
      // دالة التحقق من الإجابة
      function checkAnswer(selectedAnswer, questionData) {
        const correctAnswer = questionData.a[questionData.correct];
        const isCorrect = selectedAnswer === correctAnswer;
        
        // إضافة فئة للإجابة المختارة استنادًا إلى ما إذا كانت صحيحة أو خاطئة
        if (isCorrect) {
          // الإجابة صحيحة
          element.classList.add('correct');
          score++;
          
          // تشغيل صوت النقرة
          if (typeof playClickSound === 'function') {
            playClickSound();
          }
        } else {
          // الإجابة خاطئة
          element.classList.add('incorrect');
          
          // تشغيل صوت النقرة
          if (typeof playClickSound === 'function') {
            playClickSound();
          }
          
          // إظهار الإجابة الصحيحة بلون أخضر
          document.querySelectorAll('.answer-choice').forEach(choice => {
            if (choice.textContent === correctAnswer) {
              choice.classList.add('correct');
            }
          });
        }
        
        // الانتقال إلى السؤال التالي أو إنهاء الاختبار
        currentQuestion++;
        
        if (currentQuestion < questions.length) {
          showQuestion();
        } else {
          endQuiz();
        }
      }
      
      // دالة إنهاء الاختبار
      function endQuiz() {
        // إيقاف العداد التنازلي
        clearInterval(timer);
        
        // إخفاء حاوية المؤقت
        document.querySelector('.timer-container').style.display = 'none';
        
        // إخفاء حاوية الأسئلة وإظهار حاوية النتيجة
        document.getElementById('question-container').style.display = 'none';
        document.getElementById('result-container').style.display = 'block';
        
        // عرض النتيجة
        const resultText = document.getElementById('result-text');
        const percentage = Math.round((score / questions.length) * 100);
        
        resultText.textContent = `لقد حصلت على ${score} من ${questions.length} (${percentage}%)`;
        
        // مستمع لانتهاء اللمس - إزالة تأثير الضغط وتنفيذ الإجراء
        element.addEventListener('touchend', function(e) {
          e.preventDefault();
          this.classList.remove('pressed');
          
          // منع التفاعل المتكرر
          if (document.querySelector('.answer-choice.correct') || 
              document.querySelector('.answer-choice.incorrect')) {
            return;
          }
          
          // التحقق من الإجابة مع تمرير عنصر الإجابة
          checkAnswer(answer, questionData, this);
        }, { passive: false });
        
        // للماوس: مستمع للضغط
        element.addEventListener('mousedown', function(e) {
          this.classList.add('pressed');
        });
        
        // للماوس: مستمع للإفلات
        element.addEventListener('mouseup', function(e) {
          this.classList.remove('pressed');
          
          // منع التفاعل المتكرر
          if (document.querySelector('.answer-choice.correct') || 
              document.querySelector('.answer-choice.incorrect')) {
            return;
          }
          
          checkAnswer(answer, questionData, this);
        });
        
        // تجنب بقاء تأثير الضغط إذا تحرك المؤشر خارج العنصر
        element.addEventListener('mouseleave', function() {
          this.classList.remove('pressed');
        });
      }

      // تعديل في دالة startTimer لزيادة الوقت بسبب التأخير الإضافي في عرض الإجابات
      function startTimer() {
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        const timerContainer = document.querySelector('.timer-container');
        
        // زيادة الوقت قليلاً
        timeLeft = 35; // بدلاً من 30
        timerText.textContent = timeLeft;
        timerBar.style.width = '100%';
        timerContainer.classList.remove('timer-warning', 'timer-danger');
        
        // بدء العداد التنازلي
        timer = setInterval(function() {
          timeLeft--;
          timerText.textContent = timeLeft;
          timerBar.style.width = (timeLeft / 35 * 100) + '%'; // تعديل هنا أيضًا
          
          // تغيير لون العداد عندما يقترب الوقت من النهاية
          if (timeLeft <= 10 && timeLeft > 5) {
            timerContainer.classList.add('timer-warning');
            timerContainer.classList.remove('timer-danger');
          } else if (timeLeft <= 5) {
            timerContainer.classList.remove('timer-warning');
            timerContainer.classList.add('timer-danger');
          }
          
          // إذا انتهى الوقت، الانتقال إلى السؤال التالي
          if (timeLeft <= 0) {
            clearInterval(timer);
            
            // الانتقال إلى السؤال التالي أو إنهاء الاختبار
            currentQuestion++;
            
            if (currentQuestion < questions.length) {
              showQuestion();
            } else {
              endQuiz();
            }
          }
        }, 1000);
      }
      
      // دالة إعادة ضبط العداد التنازلي
      function resetTimer() {
        clearInterval(timer);
        startTimer();
      }
      
      // دالة ترتيب المصفوفة عشوائيًا
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      
      // تصحيح دالة endQuiz للتأكد من عرض النتيجة بشكل صحيح
      function endQuiz() {
        console.log("تم إنهاء الاختبار - النتيجة: " + score + " من " + questions.length);

        // إيقاف العداد التنازلي
        clearInterval(timer);
        
        // إخفاء حاوية المؤقت
        document.querySelector('.timer-container').style.display = 'none';
        
        // التأكد من إخفاء حاوية الأسئلة
        const questionContainer = document.getElementById('question-container');
        if (questionContainer) {
          questionContainer.style.display = 'none';
        }
        
        // التأكد من إظهار حاوية النتيجة
        const resultContainer = document.getElementById('result-container');
        if (resultContainer) {
          resultContainer.style.display = 'block';
        } else {
          console.error("لم يتم العثور على عنصر 'result-container'");
        }
        
        // عرض النتيجة
        const resultText = document.getElementById('result-text');
        if (resultText) {
          const percentage = Math.round((score / questions.length) * 100);
          resultText.textContent = `لقد حصلت على ${score} من ${questions.length} (${percentage}%)`;
        }
        
        // عرض زر الشهادة إذا كانت النتيجة كاملة
        if (score === questions.length) {
          const resultButtons = document.querySelector('.result-buttons');
          if (resultButtons && !document.getElementById('certificate-button')) {
            const certificateButton = document.createElement('a');
            certificateButton.id = 'certificate-button';
            certificateButton.href = 'certificate.html';
            certificateButton.className = 'result-button certificate clickable';
            certificateButton.textContent = 'عرض الشهادة';
            resultButtons.appendChild(certificateButton);
          }
        }
      }

      // بدء الاختبار
      initQuiz();

      // معالجة خاصة لمنع التظليل على iOS
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        document.addEventListener('touchend', function(e) {
          // منع أي تظليل أو تأثيرات تركيز بعد اللمس
          setTimeout(function() {
            // تغطية شاملة لكل الأساليب الممكنة لإزالة التظليل
            if (document.activeElement) document.activeElement.blur();
            
            // إلغاء أي تحديد نصي
            if (window.getSelection) {
              if (window.getSelection().empty) {  // Chrome
                window.getSelection().empty();
              } else if (window.getSelection().removeAllRanges) {  // Firefox
                window.getSelection().removeAllRanges();
              }
            }
          }, 10);
        }, false);
      }
    });
  </script>
</body>
</html>
